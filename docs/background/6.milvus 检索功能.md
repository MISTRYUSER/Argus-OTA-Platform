本文档将详细介绍基于 Milvus 的检索功能相关代码，包括核心组件、使用方法及关键实现细节，帮助开发者理解和使用该检索模块。

## 1. 包结构与核心功能

  

本模块属于 `retrieval` 包，主要功能是基于 Milvus 向量数据库实现文档的向量检索，支持过滤条件、自定义参数等高级功能。核心文件包括：

  

- `options.go`：定义检索选项参数
    
- `filter.go`：构建检索过滤表达式
    
- `converter.go`：向量类型转换工具
    
- `search.go`：核心检索实现
    
- `retriever.go`：检索服务封装
    

## 2. 检索选项定义（options.go）

  

该文件定义了检索时可配置的选项参数，用于控制检索范围、过滤条件等。

  

### 核心类型与常量

  

```Go
// 文档语言类型
type DocumentLanguage string

const (
    LanguageGolang     DocumentLanguage = "golang"       // Golang 相关文档
    LanguageJava       DocumentLanguage = "java"         // Java 相关文档
    LanguageMiddleware DocumentLanguage = "middleware"   // 中间件相关文档
)

// 文档类别
type DocumentCategory string

const (
    CategorySpecialized   DocumentCategory = "专项"  // 专项文档
    CategoryComprehensive DocumentCategory = "综合"  // 综合文档
    CategoryBasic         DocumentCategory = "基础"  // 基础文档
)
```

### 检索选项结构体

```Go
type RetrieveOptions struct {
    Language  DocumentLanguage  // 语言类型过滤（可选）
    Category  DocumentCategory  // 文档分类过滤（可选）
    Expr      string            // 自定义过滤表达式（优先级最高）
    TopK      int               // 返回结果数量（可选）
    Database  string            // 数据库名称（可选）
    Collection string           // 集合名称（可选，覆盖默认集合）
}
```

**参数说明**：

- 过滤条件优先级：`Expr`（自定义表达式） > `Language`/`Category`（预定义条件）
    
- `TopK` 未指定时使用配置默认值（默认10）
    
- `Collection` 可指定检索的 Milvus 集合，覆盖服务初始化时的默认集合
    

## 3. 过滤表达式构建（filter.go）

  

`BuildFilterExpr` 函数根据 `RetrieveOptions` 生成 Milvus 支持的过滤表达式，用于在检索时过滤文档。

  

### 核心实现

  

```Go
func BuildFilterExpr(opts *RetrieveOptions) string {
    if opts == nil {
        return ""
    }

    // 自定义表达式优先
    if opts.Expr != "" {
        return opts.Expr
    }

    var conditions []string

    // 语言过滤（基于 metadata 字段）
    if opts.Language != "" {
        condition := fmt.Sprintf("metadata['language'] == '%s'", string(opts.Language))
        conditions = append(conditions, condition)
    }

    // 分类过滤（基于 metadata 字段）
    if opts.Category != "" {
        condition := fmt.Sprintf("metadata['category'] == '%s'", string(opts.Category))
        conditions = append(conditions, condition)
    }

    // 多条件用 AND 连接
    if len(conditions) == 0 {
        return ""
    }
    return strings.Join(conditions, " && ")
}
```

  

**功能说明**：

- 支持基于文档元数据（`metadata`）的过滤，Milvus 中 JSON 类型字段通过 `metadata['key']` 语法访问
    
- 多条件自动通过 `&&` 连接（逻辑与）
    
- 若提供自定义 `Expr`，直接使用自定义表达式（需符合 Milvus 表达式语法）
    

## 4. 向量类型转换（converter.go）

  

Milvus 向量检索需要特定类型的向量（`entity.Vector`），该文件提供 float64 向量到 Milvus 兼容类型的转换。

  

### 核心实现

  

```Go
// 将 float64 向量转换为 Milvus FloatVector
func FloatVectorConverter(ctx context.Context, vectors [][]float64) ([]entity.Vector, error) {
    result := make([]entity.Vector, 0, len(vectors))
    for _, vector := range vectors {
        float32Vec := make([]float32, len(vector))
        for i, v := range vector {
            float32Vec[i] = float32(v)
        }
        result = append(result, entity.FloatVector(float32Vec))
    }
    return result, nil
}
```

  

**功能说明**：

- 由于 Milvus 通常使用 float32 精度向量，需将常见的 float64 向量转换为 float32
    
- 转换结果为 `entity.FloatVector` 类型，符合 Milvus SDK 要求
    
- 与索引模块（indexer）使用的向量类型保持一致，避免类型不匹配问题
    

## 5. 核心检索实现（search.go）

  

`SearchWithExpr` 函数是检索功能的核心实现，负责将查询文本转换为向量、执行 Milvus 搜索并处理返回结果。

  

### 执行流程

  

1. **获取嵌入模型并生成查询向量**
    
    ```Go
    embedder := config.Embedding
    vectors, err := embedder.EmbedStrings(ctx, []string{query})  // 将查询文本转为向量
    ```
    
2. **向量类型转换**
    
    ```Go
    queryVector := make([]float32, len(vectors[0]))
    for i, v := range vectors[0] {
        queryVector[i] = float32(v)  // 转为 float32 向量
    }
    ```
    
3. **参数确定**
    
    1. TopK：优先使用 `opts.TopK`，否则使用配置默认值（默认10）
        
    2. 集合名：优先使用 `opts.Collection`，否则使用配置默认集合
        
4. **执行 Milvus 搜索**
    
    ```Go
    searchResults, err := client.Search(
        ctx,
        collectionName,
        []string{},                            // 分区（默认不指定）
        expr,                                  // 过滤表达式
        []string{"id", "content", "metadata"}, // 需要返回的字段
        []entity.Vector{entity.FloatVector(queryVector)},  // 查询向量
        config.VectorField,                    // 向量字段名
        config.MetricType,                     // 距离度量类型（如 L2、IP）
        topK,                                  // 返回数量
        searchParam,                           // 搜索参数
    )
    ```
    
5. **结果转换为文档对象**
    
    1. 提取 `id`、`content`、`metadata` 字段
        
    2. 解析 `metadata`（JSON 格式字符串转 map）
        
    3. 添加相似度分数到 `metadata` 中
        

## 6. 检索服务封装（retriever.go）

  

`RetrieverService` 封装了 Milvus 检索器的创建和使用，提供简洁的检索接口。

  

### 服务初始化

  

```Go
func NewRetrieverService(ctx context.Context, config *milvus.RetrieverConfig) (*RetrieverService, error) {
    // 配置校验（客户端、集合名、嵌入模型等必填）
    // 设置默认值（向量字段名默认 "vector"，TopK 默认10等）
    // 初始化检索器并设置关键参数（向量转换器、搜索参数等）
    return &RetrieverService{
        retriever: retriever,
        config:    config,
        client:    config.Client,
    }, nil
}
```

  

**初始化注意事项**：

- 必须提供 Milvus 客户端（`config.Client`）
    
- 必须指定集合名（`config.Collection`）和嵌入模型（`config.Embedding`）
    
- 自动设置向量转换器为 `FloatVectorConverter`，与索引模块保持一致
    

### 核心检索方法

|   |   |   |
|---|---|---|
|方法|功能|适用场景|
|`Retrieve(ctx, query)`|基础检索（无过滤）|无需过滤条件的简单检索|
|`RetrieveWithOptions(ctx, query, opts)`|带过滤的检索|需要按语言、分类或自定义条件过滤|
|`RetrieveWithDatabaseAndCollection(...)`|指定数据库和集合的检索|跨集合检索场景|

## 7. 关键注意事项

  

1. **向量类型一致性**：确保索引时使用的向量类型（float32）与检索时一致，通过 `FloatVectorConverter` 保障
    
2. **过滤表达式语法**：自定义 `Expr` 需符合 [Milvus 表达式语法](https://milvus.io/docs/boolean.md)
    
3. **集合与字段**：检索的集合需提前创建并包含必要字段（`id`、`content`、`metadata`、向量字段）
    
4. **性能优化**：根据数据量调整 `TopK` 和搜索参数（`searchParam`），平衡精度与性能
    

通过以上组件，该模块实现了灵活、可配置的 Milvus 向量检索功能，支持多条件过滤和跨集合检索，适用于各类文档检索场景。