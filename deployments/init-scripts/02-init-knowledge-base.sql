-- Argus OTA Platform - Knowledge Base for RAG
-- Version: 2.0
-- Description: 存储历史诊断案例，用于混合检索（SQL 硬过滤 + 向量语义排序）

-- ============================================================================
-- Knowledge Base Table
-- ============================================================================

CREATE TABLE IF NOT EXISTS knowledge_base (
    id BIGSERIAL PRIMARY KEY,
    -- 元数据（用于 SQL 硬过滤）
    error_code VARCHAR(50) NOT NULL,
    vehicle_platform VARCHAR(50) NOT NULL,
    component VARCHAR(100),
    severity VARCHAR(20) NOT NULL,

    -- 文本内容（用于 LLM 上下文）
    symptom_text TEXT NOT NULL,
    solution_text TEXT NOT NULL,

    -- 向量嵌入（用于语义检索）
    embedding VECTOR(1536) NOT NULL,

    -- 元数据
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- 约束
    CONSTRAINT kb_severity_check CHECK (severity IN (
        'info', 'warning', 'error', 'critical'
    ))
);

-- ============================================================================
-- Indexes (三层索引策略)
-- ============================================================================

-- L1: B-Tree 索引（SQL 硬过滤）
CREATE INDEX IF NOT EXISTS idx_kb_error_code ON knowledge_base(error_code);
CREATE INDEX IF NOT EXISTS idx_kb_vehicle_platform ON knowledge_base(vehicle_platform);
CREATE INDEX IF NOT EXISTS idx_kb_component ON knowledge_base(component);
CREATE INDEX IF NOT EXISTS idx_kb_severity ON knowledge_base(severity);

-- L2: HNSW 索引（向量语义排序）
-- HNSW (Hierarchical Navigable Small World) 用于近似最近邻搜索
-- vector_cosine_ops: 余弦相似度
CREATE INDEX IF NOT EXISTS idx_kb_embedding_hnsw
    ON knowledge_base
    USING hnsw (embedding vector_cosine_ops)
    WITH (m = 16, ef_construction = 64);

-- L3: 复合索引（可选，用于特定查询模式）
CREATE INDEX IF NOT EXISTS idx_kb_error_platform
    ON knowledge_base(error_code, vehicle_platform);

-- ============================================================================
-- Comments
-- ============================================================================

COMMENT ON TABLE knowledge_base IS 'RAG 知识库：存储历史诊断案例，支持混合检索（SQL + 向量）';
COMMENT ON COLUMN knowledge_base.error_code IS '错误代码（用于 SQL 过滤）';
COMMENT ON COLUMN knowledge_base.vehicle_platform IS '车辆平台（J7, J6, etc.）';
COMMENT ON COLUMN knowledge_base.symptom_text IS '症状描述（用于生成 embedding）';
COMMENT ON COLUMN knowledge_base.solution_text IS '解决方案（LLM 输出）';
COMMENT ON COLUMN knowledge_base.embedding IS 'OpenAI text-embedding-ada-002 向量（1536 维）';

-- ============================================================================
-- Mock Data (10 条历史案例)
-- ============================================================================
-- 注意：这里使用的是简化的 mock 向量（全为 0.01）
-- 实际生产环境需要调用 OpenAI Embedding API 生成真实向量

INSERT INTO knowledge_base (error_code, vehicle_platform, component, severity, symptom_text, solution_text, embedding)
VALUES
    -- 案例 1: CPU 过热
    (
        'E001',
        'J7',
        'CPU',
        'critical',
        'CPU 温度持续在 95°C 以上，触发温度告警。系统日志显示风扇转速异常，BIOS 版本过旧导致温控策略失效。',
        '解决方案：(1) 检查风扇物理连接，清理散热器灰尘；(2) 升级 BIOS 到最新版本以修复温控策略；(3) 调整 CPU 工作模式为平衡模式。',
        ARRAY[0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01,
              0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01]::VECTOR(1536)
    ),

    -- 案例 2: 激光雷达丢失
    (
        'E002',
        'J7',
        'LiDAR',
        'critical',
        '主激光雷达频繁丢失点云数据，系统日志显示网线连接不稳定。LiDAR IP 配置冲突导致数据包丢包率超过 5%。',
        '解决方案：(1) 检查 LiDAR 网线连接，替换损坏的网线；(2) 修改 LiDAR IP 地址避免冲突；(3) 配置网络 MTU 为 9000 以支持 jumbo frame；(4) 重启 LiDAR 驱动程序。',
        ARRAY[0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02,
              0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02, 0.02]::VECTOR(1536)
    ),

    -- 案例 3: 内存泄漏
    (
        'E003',
        'J6',
        'Memory',
        'error',
        '系统内存使用率持续上升，24 小时内从 40% 增长到 95%。分析显示日志采集模块存在内存泄漏，未释放的 buffer 导致 OOM。',
        '解决方案：(1) 升级日志采集模块到 v2.3.1（已修复内存泄漏）；(2) 增加内存监控告警阈值到 80%；(3) 配置 systemd 自动重启服务。',
        ARRAY[0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03,
              0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03, 0.03]::VECTOR(1536)
    ),

    -- 案例 4: 磁盘 IO 瓶颈
    (
        'E004',
        'J7',
        'Storage',
        'warning',
        '日志写入速度超过磁盘 IOPS 上限，导致写入延迟超过 1s。系统使用 HDD 而非 SSD，高并发下磁盘队列深度达到 100。',
        '解决方案：(1) 升级存储介质为 NVMe SSD；(2) 启用日志批量写入（batch size = 100）；(3) 配置日志轮转策略，减少单个文件大小；(4) 考虑使用 Kafka 缓冲写入。',
        ARRAY[0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04,
              0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04, 0.04]::VECTOR(1536)
    ),

    -- 案例 5: GPS 信号丢失
    (
        'E005',
        'J6',
        'GPS',
        'warning',
        'GPS 模块间歇性丢失卫星信号，导致定位精度下降到 100 米以上。检查发现 GPS 天线被金属物遮挡，卫星可见数量从 12 颗下降到 4 颗。',
        '解决方案：(1) 重新调整 GPS 天线位置，确保视野开阔；(2) 检查天线馈线连接，更换损坏的馈线；(3) 启用 GPS 惯性导航作为备用方案；(4) 更新 GPS 固件到最新版本。',
        ARRAY[0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05,
              0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05]::VECTOR(1536)
    ),

    -- 案例 6: CAN 总线过载
    (
        'E006',
        'J7',
        'CAN Bus',
        'error',
        'CAN 总线负载率达到 85%，消息延迟超过 50ms。分析显示日志采集模块发送频率过高（100Hz），导致带宽瓶颈。',
        '解决方案：(1) 降低日志采集频率到 20Hz；(2) 启用 CAN-FD 协议以提高带宽；(3) 优化 CAN 消息优先级，确保关键消息优先传输；(4) 分离控制总线和诊断总线。',
        ARRAY[0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06,
              0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06, 0.06]::VECTOR(1536)
    ),

    -- 案例 7: 摄像头延迟
    (
        'E007',
        'J7',
        'Camera',
        'warning',
        '前视摄像头图像延迟达到 200ms，导致感知算法误检。日志显示图像处理线程优先级过低，被高优先级任务抢占。',
        '解决方案：(1) 提升图像处理线程优先级到实时优先级（RT priority）；(2) 启用 GPU 硬件加速；(3) 优化图像处理算法，降低计算复杂度；(4) 配置 CPU 亲和性，绑定图像处理到专用核心。',
        ARRAY[0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07,
              0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07, 0.07]::VECTOR(1536)
    ),

    -- 案例 8: 传感器时间同步失败
    (
        'E008',
        'J6',
        'Sensor Sync',
        'error',
        '多传感器时间同步失败，LiDAR 和 Camera 时间戳偏差超过 50ms。PTP 协议配置错误，主时钟源不可用。',
        '解决方案：(1) 检查 PTP 配置文件，修正时钟源设置；(2) 配置冗余主时钟源；(3) 启用硬件时间戳功能；(4) 验证网络交换机是否支持 PTP；(5) 定期校准传感器时钟。',
        ARRAY[0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08,
              0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08]::VECTOR(1536)
    ),

    -- 案例 9: 电源供应不稳定
    (
        'E009',
        'J7',
        'Power',
        'critical',
        '系统电压波动超过 ±10%，导致传感器频繁复位。电源模块老化，无法提供稳定电流。峰值电流时电压跌落到 10.8V（标准 12V）。',
        '解决方案：(1) 更换电源模块；（2）增加大容量电容以平滑电压波动；(3) 配置电压监控告警（阈值 ±5%）；(4) 检查接地线是否可靠；(5) 考虑使用冗余电源方案。',
        ARRAY[0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09,
              0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09, 0.09]::VECTOR(1536)
    ),

    -- 案例 10: 网络连接超时
    (
        'E010',
        'J6',
        'Network',
        'warning',
        '云端通信频繁超时，成功率只有 60%。分析显示 DNS 解析慢，TCP 连接建立时间超过 3s。网络带宽充足但延迟高。',
        '解决方案：(1) 配置本地 DNS 缓存，减少 DNS 查询延迟；(2) 启用 HTTP 连接池和 Keep-Alive；(3) 配置请求超时和重试策略（指数退避）；(4) 考虑使用 CDN 加速；(5) 监控网络质量指标（延迟、丢包率）。',
        ARRAY[0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10,
              0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10]::VECTOR(1536)
    );

-- ============================================================================
-- Sample Queries (for testing)
-- ============================================================================

-- 测试 1: 查询所有记录
-- SELECT * FROM knowledge_base;

-- 测试 2: SQL 硬过滤（L1 过滤）
-- SELECT * FROM knowledge_base
-- WHERE error_code = 'E001' AND vehicle_platform = 'J7';

-- 测试 3: 向量语义排序（L2 排序）
-- SELECT
--     id,
--     error_code,
--     symptom_text,
--     1 - (embedding <=> '[0.01, 0.01, ...]') as similarity
-- FROM knowledge_base
-- ORDER BY similarity DESC
-- LIMIT 5;

-- 测试 4: 混合检索（L1 + L2）
-- SELECT
--     id,
--     error_code,
--     vehicle_platform,
--     symptom_text,
--     solution_text,
--     1 - (embedding <=> '[0.01, 0.01, ...]') as similarity
-- FROM knowledge_base
-- WHERE error_code = 'E001'
--   AND vehicle_platform = 'J7'
-- ORDER BY similarity DESC
-- LIMIT 5;

-- ============================================================================
-- Performance Analysis
-- ============================================================================

-- 查看索引使用情况
-- EXPLAIN ANALYZE
-- SELECT * FROM knowledge_base
-- WHERE error_code = 'E001'
-- ORDER BY embedding <=> '[0.01, 0.01, ...]'
-- LIMIT 5;

-- 查看表统计信息
-- SELECT
--     count(*) as total_records,
--     count(DISTINCT error_code) as unique_error_codes,
--     count(DISTINCT vehicle_platform) as unique_platforms
-- FROM knowledge_base;
